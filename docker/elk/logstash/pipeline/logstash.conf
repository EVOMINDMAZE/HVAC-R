input {
  beats {
    port => 5000
    codec => json
  }
  
  tcp {
    port => 5001
    codec => json_lines
  }
  
  http {
    port => 8080
    codec => json
    response_headers => {
      "Content-Type" => "application/json"
      "Access-Control-Allow-Origin" => "*"
    }
  }
}

filter {
  # Parse timestamp if not already parsed
  if [timestamp] {
    date {
      match => ["timestamp", "ISO8601", "yyyy-MM-dd'T'HH:mm:ss.SSSZ", "yyyy-MM-dd HH:mm:ss"]
      target => "@timestamp"
    }
  }
  
  # Add environment tag
  mutate {
    add_field => {
      "environment" => "${ENVIRONMENT:production}"
      "application" => "thermoneural"
    }
  }
  
  # Normalize log levels
  if [level] {
    mutate {
      uppercase => ["level"]
    }
  }
  
  # Extract user info if present
  if [userId] {
    mutate {
      add_field => {
        "user_context" => "%{userId}"
      }
    }
  }
  
  # Extract request info if present
  if [requestId] {
    mutate {
      add_field => {
        "request_context" => "%{requestId}"
      }
    }
  }
  
  # Parse user agent
  if [userAgent] {
    useragent {
      source => "userAgent"
      target => "user_agent_parsed"
    }
  }
  
  # GeoIP for client IP
  if [ip] and [ip] != "127.0.0.1" and [ip] != "::1" {
    geoip {
      source => "ip"
      target => "geoip"
      add_tag => ["geoip"]
    }
  }
  
  # Calculate response time if present
  if [duration] {
    mutate {
      convert => { "duration" => "float" }
    }
  }
  
  # Tag errors
  if [level] == "ERROR" or [level] == "FATAL" {
    mutate {
      add_tag => ["error", "needs-attention"]
    }
  }
  
  # Tag warnings
  if [level] == "WARN" {
    mutate {
      add_tag => ["warning"]
    }
  }
  
  # Tag API calls
  if [endpoint] {
    mutate {
      add_tag => ["api-request"]
    }
  }
  
  # Tag authentication events
  if [event] == "auth" or [event] == "login" or [event] == "logout" {
    mutate {
      add_tag => ["authentication"]
    }
  }
  
  # Tag security events
  if [category] == "security" or [type] == "security" {
    mutate {
      add_tag => ["security-event"]
    }
  }
  
  # Tag performance issues
  if [duration] and [duration] > 2000 {
    mutate {
      add_tag => ["slow-request"]
    }
  }
}

output {
  elasticsearch {
    hosts => ["elasticsearch:9200"]
    index => "thermoneural-logs-%{+YYYY.MM.dd}"
    document_id => "%{[@metadata][_id]}"
    retry_on_conflict => 3
  }
  
  # Separate error index
  if "error" in [tags] {
    elasticsearch {
      hosts => ["elasticsearch:9200"]
      index => "thermoneural-errors-%{+YYYY.MM.dd}"
    }
  }
  
  # Separate security events index
  if "security-event" in [tags] {
    elasticsearch {
      hosts => ["elasticsearch:9200"]
      index => "thermoneural-security-%{+YYYY.MM.dd}"
    }
  }
  
  # Debug output (remove in production)
  stdout {
    codec => rubydebug {
      metadata => false
    }
  }
}