name: Deploy ThermoNeural

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      deploy_target:
        description: "Deployment target"
        required: true
        default: "all"
        type: choice
        options:
          - all
          - supabase-only
          - frontend-only
          - functions-only

env:
  SUPABASE_PROJECT_REF: rxqflxmzsqhqrzffcsej
  NODE_VERSION: "20"

jobs:
  # ============================================
  # JOB 1: Run Tests
  # ============================================
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Run type check
        run: npm run typecheck

      - name: Run unit tests
        run: npm run test

  # ============================================
  # JOB 2: Deploy Supabase Migrations
  # ============================================
  deploy-supabase-db:
    name: Deploy Database Migrations
    runs-on: ubuntu-latest
    needs: test
    if: |
      github.event_name == 'push' || 
      github.event.inputs.deploy_target == 'all' || 
      github.event.inputs.deploy_target == 'supabase-only'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Link Supabase project
        run: |
          supabase link --project-ref ${{ env.SUPABASE_PROJECT_REF }}
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}

      - name: Push database migrations
        run: |
          supabase db push
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_DB_PASSWORD: ${{ secrets.SUPABASE_DB_PASSWORD }}

  # ============================================
  # JOB 3: Deploy Edge Functions (Parallel)
  # ============================================
  deploy-edge-functions:
    name: Deploy Edge Functions
    runs-on: ubuntu-latest
    needs: deploy-supabase-db
    if: |
      github.event_name == 'push' || 
      github.event.inputs.deploy_target == 'all' || 
      github.event.inputs.deploy_target == 'supabase-only' ||
      github.event.inputs.deploy_target == 'functions-only'
    strategy:
      matrix:
        function:
          - ai-gateway
          - ai-troubleshoot
          - analyze-selling-points
          - analyze-triage-media
          - billing
          - ingest-telemetry
          - invite-user
          - invoice-chaser
          - oauth-token-exchange
          - poll-integrations
          - recommended-range
          - refresh-oauth-token
          - review-hunter
          - stripe-webhook
          - sync-spreadsheets
          - transcribe-audio
          - update-role
          - validate-import
          - verify-license
          - warranty-lookup
          - webhook-dispatcher
      fail-fast: false
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Link Supabase project
        run: |
          supabase link --project-ref ${{ env.SUPABASE_PROJECT_REF }}
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}

      - name: Deploy function - ${{ matrix.function }}
        run: |
          supabase functions deploy ${{ matrix.function }} --no-verify-jwt
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}

  # ============================================
  # JOB 4: Build & Deploy Frontend to Netlify
  # ============================================
  deploy-frontend:
    name: Deploy Frontend to Netlify
    runs-on: ubuntu-latest
    needs: test
    if: |
      github.event_name == 'push' || 
      github.event.inputs.deploy_target == 'all' || 
      github.event.inputs.deploy_target == 'frontend-only'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Build client
        run: npm run build:client
        env:
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}
          VITE_STRIPE_PUBLISHABLE_KEY: ${{ secrets.VITE_STRIPE_PUBLISHABLE_KEY }}

      - name: Deploy to Netlify
        uses: nwtgck/actions-netlify@v3.0
        with:
          publish-dir: "./dist/spa"
          production-branch: main
          production-deploy: true
          github-token: ${{ secrets.GITHUB_TOKEN }}
          deploy-message: "Deploy from GitHub Actions - ${{ github.sha }}"
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}

  # ============================================
  # JOB 5: Trigger Render Deployment
  # ============================================
  deploy-render:
    name: Deploy Calculation Service to Render
    runs-on: ubuntu-latest
    needs: test
    if: |
      github.event_name == 'push' || 
      github.event.inputs.deploy_target == 'all'
    steps:
      - name: Trigger Render Deploy Hook
        run: |
          curl -X POST "${{ secrets.RENDER_DEPLOY_HOOK_URL }}" \
            -H "Content-Type: application/json" \
            -d '{"clearCache": false}'
        continue-on-error: true

  # ============================================
  # JOB 6: Post-Deployment Verification
  # ============================================
  verify-deployment:
    name: Verify Deployment
    runs-on: ubuntu-latest
    needs:
      [
        deploy-supabase-db,
        deploy-edge-functions,
        deploy-frontend,
        deploy-render,
      ]
    if: always() && (needs.deploy-frontend.result == 'success' || needs.deploy-supabase-db.result == 'success')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Verify Supabase connection
        run: |
          node -e "
          const { createClient } = require('@supabase/supabase-js');
          const supabase = createClient('${{ secrets.VITE_SUPABASE_URL }}', '${{ secrets.VITE_SUPABASE_ANON_KEY }}');

          async function verify() {
            // Test database connection
            const { data, error } = await supabase.from('companies').select('count').limit(1);
            if (error) {
              console.error('Database connection failed:', error.message);
              process.exit(1);
            }
            console.log('Database connection: OK');
            
            // Test AI tables
            const { error: aiError } = await supabase.from('ai_learning_patterns').select('count').limit(1);
            if (aiError) {
              console.error('AI tables check failed:', aiError.message);
              process.exit(1);
            }
            console.log('AI tables: OK');
            
            console.log('All verification checks passed!');
          }

          verify().catch(e => { console.error(e); process.exit(1); });
          "

      - name: Verify Render service
        run: |
          RENDER_URL="${{ secrets.RENDER_SERVICE_URL }}"
          if [ -n "$RENDER_URL" ]; then
            response=$(curl -s -o /dev/null -w "%{http_code}" "$RENDER_URL/health" || echo "000")
            if [ "$response" = "200" ]; then
              echo "Render service: OK"
            else
              echo "Render service: Warning (HTTP $response)"
            fi
          else
            echo "Render service URL not configured, skipping check"
          fi
        continue-on-error: true

      - name: Create deployment summary
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Tests | ${{ needs.test.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Database | ${{ needs.deploy-supabase-db.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Edge Functions | ${{ needs.deploy-edge-functions.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend | ${{ needs.deploy-frontend.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Render | ${{ needs.deploy-render.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Deployed at:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # JOB 7: Notify on Failure
  # ============================================
  notify-failure:
    name: Notify on Failure
    runs-on: ubuntu-latest
    needs: [test, deploy-supabase-db, deploy-edge-functions, deploy-frontend]
    if: failure()
    steps:
      - name: Create failure issue
        uses: actions/github-script@v7
        with:
          script: |
            const title = `Deployment Failed - ${new Date().toISOString().split('T')[0]}`;
            const body = `
            ## Deployment Failure Report

            **Commit:** \`${{ github.sha }}\`
            **Branch:** \`${{ github.ref_name }}\`
            **Workflow:** [View Run](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})

            ### Job Results
            - Tests: ${{ needs.test.result }}
            - Database: ${{ needs.deploy-supabase-db.result }}
            - Edge Functions: ${{ needs.deploy-edge-functions.result }}
            - Frontend: ${{ needs.deploy-frontend.result }}

            Please investigate and fix the deployment issues.
            `;

            // Only create issue if it doesn't exist
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'deployment-failure'
            });

            if (issues.length === 0) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title,
                body,
                labels: ['deployment-failure', 'automated']
              });
            }
