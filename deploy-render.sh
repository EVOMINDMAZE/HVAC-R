#!/bin/bash

echo "ğŸš€ Deploying HVAC-R Server to Render"
echo "======================================"

# Check if Render CLI is installed
if ! command -v render &> /dev/null; then
    echo "ğŸ“¦ Installing Render CLI..."
    npm install -g render-cli 2>&1 || echo "Note: Install Render CLI manually: npm i -g render"
fi

# Verify build exists
if [ ! -d "dist/server" ]; then
    echo "ğŸ”¨ Building application..."
    npm run build
fi

echo "âœ… Build verified"

# Show deployment options
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸ¯ DEPLOYMENT OPTIONS"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "Option 1: Render Dashboard (Recommended)"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "1. Go to https://dashboard.render.com"
echo "2. Click 'New' â†’ 'Web Service'"
echo "3. Connect GitHub repository"
echo "4. Configure:"
echo "   â€¢ Build Command: npm run build"
echo "   â€¢ Start Command: npm run start"
echo "   â€¢ Environment: Node"
echo "   â€¢ Plan: Standard (recommended for calculations)"
echo ""
echo "5. Add Environment Variables:"
echo "   NODE_ENV=production"
echo "   VITE_SUPABASE_URL=https://rxqflxmzsqhqrzffcsej.supabase.co"
echo "   VITE_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
echo "   SUPABASE_SERVICE_ROLE_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
echo "   SUPABASE_DB_PASSWORD=TddR7OpEdrkbbwOE"
echo ""
echo "6. Click 'Create Web Service'"
echo ""

echo "Option 2: Render CLI"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "render deploy --spec render.yaml"
echo ""

echo "Option 3: Render Blueprints (Infrastructure as Code)"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "1. Go to https://dashboard.render.com/blueprints"
echo "2. Click 'New Blueprint'"
echo "3. Connect GitHub repository"
echo "4. Render will automatically detect render.yaml"
echo "5. Click 'Apply Blueprint'"
echo ""

echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸ“Š DEPLOYMENT CONFIGURATION"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "Server Specifications:"
echo "  â€¢ Type: Web Service"
echo "  â€¢ Environment: Node.js"
echo "  â€¢ Region: us-east (or closest to users)"
echo "  â€¢ Plan: Standard (\$25/mo) - for heavy calculations"
echo "  â€¢ Min Instances: 1"
echo "  â€¢ Max Instances: 3 (auto-scaling)"
echo ""
echo "Health Check:"
echo "  â€¢ Path: /"
echo "  â€¢ Timeout: 30 seconds"
echo ""
echo "Environment Variables:"
echo "  â€¢ NODE_ENV=production"
echo "  â€¢ VITE_SUPABASE_URL=https://rxqflxmzsqhqrzffcsej.supabase.co"
echo "  â€¢ VITE_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
echo "  â€¢ SUPABASE_SERVICE_ROLE_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
echo "  â€¢ SUPABASE_DB_PASSWORD=TddR7OpEdrkbbwOE"
echo ""

echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸ”— ENDPOINT REFERENCE"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "After deployment, your server will be available at:"
echo "  https://hvacr-server.onrender.com"
echo ""
echo "API Endpoints:"
echo "  â€¢ POST /ai/analyze - AI pattern analysis"
echo "  â€¢ POST /ai/patterns/symptom-outcome - Create pattern"
echo "  â€¢ GET /ai/patterns - Get patterns"
echo "  â€¢ POST /troubleshoot - Troubleshooting workflow"
echo "  â€¢ POST /engineering/airflow - Airflow calculations"
echo "  â€¢ POST /engineering/delta-t - Delta T calculations"
echo "  â€¢ POST /engineering/standard-cycle - Standard cycle calc"
echo ""

echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "âœ… PRE-DEPLOYMENT CHECKLIST"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "[ ] Git repository is up to date"
echo "[ ] All tests pass: npm run test"
echo "[ ] TypeScript compiles: npm run typecheck"
echo "[ ] Build succeeds: npm run build"
echo "[ ] Environment variables tested"
echo "[ ] Supabase connection verified"
echo ""

echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸš€ QUICK DEPLOY (Render Dashboard)"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "1. Open: https://dashboard.render.com"
echo "2. Sign in / Sign up"
echo "3. Click 'New' â†’ 'Web Service'"
echo "4. Select 'Build and deploy from a Git repository'"
echo "5. Choose your GitHub repo"
echo "6. Configure as above"
echo "7. Add environment variables"
echo "8. Click 'Create Web Service'"
echo ""
echo "ğŸ“ Your render.yaml file is ready for Blueprint deployments"
echo ""

echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸ”§ POST-DEPLOYMENT"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "1. Copy your Render server URL"
echo "2. Update Supabase if needed"
echo "3. Test endpoints:"
echo "   curl https://your-render-url.com"
echo "4. Monitor logs in Render dashboard"
echo "5. Set up custom domain (optional)"
echo ""

echo "âœ… Deployment guide complete!"
