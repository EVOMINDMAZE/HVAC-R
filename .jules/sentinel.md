## 2026-02-13 - Rate Limiter Global State Bug
**Vulnerability:** The rate limiter's default handler was referencing a global `defaultStore` instead of the instance-specific store. This caused `X-RateLimit-Reset` headers to return `Date.now()` (or NaN) instead of the actual reset time, effectively locking out clients indefinitely if they respected the header, or causing them to retry immediately if they interpreted it as a past timestamp.
**Learning:** Middleware factories that create closures (like `createRateLimiter`) must ensure that any external helpers (like `defaultHandler`) have access to the closure's state, either by passing the state or by defining the helper inside the closure. Global state for rate limiting is dangerous as it doesn't isolate different limiters (e.g. auth vs standard).
**Prevention:** Avoid relying on global variables for stateful middleware. Pass all necessary context (like `resetTime`) explicitly to handlers. Unit test the `reset` header specifically with mocked time or precise assertions.
